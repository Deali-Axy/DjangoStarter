{% extends 'demo/_chat_base.html' %}
{% load static %}

{% block title %}DjangoStarter AI Chat{% endblock %}

{% block main_x_data %}x-data="chatApp()"{% endblock %}

{% block chat_messages %}
<div class="flex flex-col h-full">
    
    <!-- Empty State -->
    <div class="flex-1 flex flex-col items-center justify-center p-8 text-center" 
         x-show="messages.length === 0" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100">
        
        <div class="w-16 h-16 bg-base-200 rounded-2xl flex items-center justify-center mb-6 shadow-sm">
            <i class="fa-solid fa-robot text-4xl text-base-content/70"></i>
        </div>
        <h2 class="text-2xl font-bold mb-2">How can I help you today?</h2>
        <p class="text-base-content/60 max-w-md mb-8">This is a streaming demo using Server-Sent Events (SSE). Select a mode from the header to test different capabilities.</p>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-2xl">
            <button @click="quickStart('Explain quantum computing in simple terms')" class="btn btn-outline border-base-300 hover:bg-base-200 hover:border-base-300 h-auto py-3 px-4 justify-start text-left font-normal normal-case group">
                <div class="flex flex-col gap-1">
                    <span class="font-semibold text-sm group-hover:text-primary transition-colors">Explain quantum computing</span>
                    <span class="text-xs opacity-60">in simple terms</span>
                </div>
            </button>
            <button @click="quickStart('Write a Python script to scrape a website')" class="btn btn-outline border-base-300 hover:bg-base-200 hover:border-base-300 h-auto py-3 px-4 justify-start text-left font-normal normal-case group">
                <div class="flex flex-col gap-1">
                    <span class="font-semibold text-sm group-hover:text-primary transition-colors">Write a Python script</span>
                    <span class="text-xs opacity-60">to scrape a website</span>
                </div>
            </button>
            <button @click="quickStart('How do I make an HTTP request in Javascript?')" class="btn btn-outline border-base-300 hover:bg-base-200 hover:border-base-300 h-auto py-3 px-4 justify-start text-left font-normal normal-case group">
                <div class="flex flex-col gap-1">
                    <span class="font-semibold text-sm group-hover:text-primary transition-colors">HTTP request in JS</span>
                    <span class="text-xs opacity-60">using fetch or axios</span>
                </div>
            </button>
            <button @click="quickStart('Tell me a fun fact about space')" class="btn btn-outline border-base-300 hover:bg-base-200 hover:border-base-300 h-auto py-3 px-4 justify-start text-left font-normal normal-case group">
                <div class="flex flex-col gap-1">
                    <span class="font-semibold text-sm group-hover:text-primary transition-colors">Fun fact about space</span>
                    <span class="text-xs opacity-60">surprise me</span>
                </div>
            </button>
        </div>
    </div>

    <!-- Message List -->
    <div class="flex-1 overflow-y-auto chat-scroll p-4 lg:p-0" x-show="messages.length > 0">
        <div class="max-w-3xl mx-auto py-6 space-y-6">
            <template x-for="msg in messages" :key="msg.id">
                <div class="group w-full text-base-content border-b border-black/5 dark:border-white/5 pb-6 last:border-0">
                    <div class="flex gap-4 lg:gap-6 md:max-w-3xl lg:max-w-[40rem] xl:max-w-[48rem] mx-auto">
                        
                        <!-- Avatar -->
                        <div class="flex-shrink-0 flex flex-col relative items-end">
                            <div class="w-8 h-8 rounded-sm flex items-center justify-center overflow-hidden"
                                 :class="msg.role === 'user' ? 'bg-base-300' : 'bg-primary text-primary-content'">
                                <template x-if="msg.role === 'user'">
                                    <i class="fa-solid fa-user text-sm opacity-60"></i>
                                </template>
                                <template x-if="msg.role === 'ai'">
                                    <i class="fa-solid fa-robot text-sm"></i>
                                </template>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="relative flex-1 overflow-hidden">
                            <!-- Author Name -->
                            <div class="font-semibold text-sm mb-1 opacity-90" x-text="msg.role === 'user' ? 'You' : 'DjangoStarter AI'"></div>
                            
                            <!-- Message Body -->
                            <div class="prose prose-sm max-w-none break-words leading-7" 
                                 :class="msg.isError ? 'text-error' : ''">
                                <div class="whitespace-pre-wrap" x-text="msg.content"></div>
                                
                                <!-- Thinking/Loading Indicator -->
                                <template x-if="msg.isThinking">
                                    <div class="flex items-center gap-2 mt-2 text-base-content/50 animate-pulse">
                                        <div class="w-2 h-2 rounded-full bg-current"></div>
                                        <span class="text-xs" x-text="msg.thinkingText || 'Thinking...'"></span>
                                    </div>
                                </template>

                                <!-- Streaming Cursor -->
                                <template x-if="msg.role === 'ai' && msg.status !== 'done' && !msg.isThinking">
                                    <span class="inline-block w-2 h-4 align-middle bg-current animate-pulse ml-0.5"></span>
                                </template>
                            </div>

                            <!-- Footer / Actions -->
                            <div class="flex items-center gap-2 mt-2 opacity-0 group-hover:opacity-100 transition-opacity" x-show="!msg.isThinking && msg.status === 'done'">
                                <button class="btn btn-ghost btn-xs btn-square text-base-content/50 hover:text-base-content" title="Copy">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                <button class="btn btn-ghost btn-xs btn-square text-base-content/50 hover:text-base-content" title="Regenerate">
                                    <i class="fa-solid fa-rotate-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            <div id="scroll-anchor" class="h-12"></div>
        </div>
    </div>

    <!-- Input Area (Injected via Portal or fixed positioning in base) -->
    <!-- We use Alpine to portal this to the base template's input block if needed, 
         but since we are extending, we can just override the block -->
</div>
{% endblock %}

{% block chat_input %}
<!-- Input Form -->
<form @submit.prevent="submit" class="relative w-full">
    <div class="relative flex items-end w-full p-3 bg-base-100 border border-base-300 rounded-xl shadow-sm focus-within:ring-1 focus-within:ring-base-300 focus-within:border-base-300 overflow-hidden ring-offset-2 focus-within:ring-offset-1">
        
        <!-- File Upload (Mock) -->
        <button type="button" class="btn btn-circle btn-ghost btn-sm text-base-content/50 hover:text-base-content hover:bg-base-200 mr-2" title="Attach files">
            <i class="fa-solid fa-paperclip"></i>
        </button>

        <!-- Textarea -->
        <textarea 
            x-model="input" 
            class="w-full max-h-[200px] py-2 bg-transparent border-0 focus:ring-0 resize-none outline-none text-base leading-6 scrollbar-hide placeholder:text-base-content/40" 
            :placeholder="inputPlaceholder"
            rows="1"
            style="min-height: 24px;"
            @input="$el.style.height = 'auto'; $el.style.height = $el.scrollHeight + 'px'"
            @keydown.enter.prevent="if(!$event.shiftKey) submit()"
            :disabled="isConnected && !canInterrupt"
        ></textarea>

        <!-- Send/Stop Button -->
        <div class="ml-2 mb-0.5">
            <template x-if="!isConnected">
                <button type="submit" 
                        class="btn btn-sm btn-square rounded-lg transition-all duration-200"
                        :class="input.trim() ? 'btn-primary text-primary-content' : 'btn-ghost text-base-content/30 bg-base-200/50 cursor-not-allowed'"
                        :disabled="!input.trim()">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </template>
            <template x-if="isConnected">
                <button type="button" @click="stop" class="btn btn-sm btn-square btn-neutral rounded-full animate-pulse text-white" title="Stop generating">
                    <i class="fa-solid fa-stop text-xs"></i>
                </button>
            </template>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('chatApp', () => ({
            messages: [],
            input: '',
            mode: 'chat',
            isConnected: false,
            eventSource: null,
            statusText: 'Ready',
            
            init() {
                // Listen for mode changes from header
                window.addEventListener('mode-change', (e) => {
                    this.mode = e.detail;
                    this.clearHistory(false); // Clear history on mode switch? Optional.
                });

                // Listen for new chat event
                window.addEventListener('new-chat', () => {
                    this.clearHistory();
                });
            },

            get inputPlaceholder() {
                const map = {
                    'chat': 'Message ChatGPT...',
                    'polish': 'Enter text to polish...',
                    'text': 'Enter a prompt to generate text...',
                    'counter': 'Click send to start counting...',
                    'realtime': 'Click send to stream data...'
                };
                return map[this.mode] || 'Send a message...';
            },

            get canInterrupt() {
                return true;
            },

            formatTime(ts) {
                if (!ts) return '';
                return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            },

            clearHistory(confirmClear = true) {
                if (!confirmClear || this.messages.length === 0 || confirm('Start a new chat? This will clear current history.')) {
                    this.messages = [];
                    this.isConnected = false;
                    if(this.eventSource) this.eventSource.close();
                }
            },

            quickStart(text) {
                this.input = text;
                this.submit();
            },

            scrollToBottom() {
                this.$nextTick(() => {
                    const anchor = document.getElementById('scroll-anchor');
                    if(anchor) anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
                });
            },

            submit() {
                if (this.isConnected) return;
                
                const text = this.input.trim();
                if (!text && !['counter', 'realtime'].includes(this.mode)) return;

                // Reset textarea height
                const textarea = document.querySelector('textarea');
                if(textarea) textarea.style.height = 'auto';

                // 1. Add User Message
                if (text) {
                    this.messages.push({
                        id: Date.now(),
                        role: 'user',
                        content: text,
                        timestamp: Date.now()
                    });
                }
                
                this.input = '';
                this.scrollToBottom();

                // 2. Start AI Stream
                this.startStream(text);
            },

            startStream(inputText) {
                this.isConnected = true;
                this.statusText = 'Connecting...';
                
                // Create placeholder AI message
                const msgId = Date.now() + 1;
                const aiMsg = {
                    id: msgId,
                    role: 'ai',
                    content: '',
                    isThinking: false,
                    thinkingText: '',
                    status: 'Connecting...',
                    isError: false,
                    timestamp: Date.now()
                };
                this.messages.push(aiMsg);
                this.scrollToBottom();

                // Construct URL
                let url = '';
                const encodedText = encodeURIComponent(inputText);
                
                switch(this.mode) {
                    case 'chat':
                        url = `/api/demo/streaming/stream/chat?message=${encodedText}`;
                        break;
                    case 'polish':
                        url = `/api/demo/streaming/stream/llm-polish?text=${encodedText}`;
                        break;
                    case 'text':
                        url = `/api/demo/streaming/stream/text?text=${encodedText}`;
                        break;
                    case 'counter':
                        url = `/api/demo/streaming/stream/counter`;
                        break;
                    case 'realtime':
                        url = `/api/demo/streaming/stream/realtime`;
                        break;
                    default:
                        this.handleError(msgId, 'Unknown mode');
                        return;
                }

                // Init SSE
                if (this.eventSource) this.eventSource.close();
                this.eventSource = new EventSource(url);

                this.eventSource.onopen = () => {
                    this.statusText = 'Generating...';
                    this.updateMsg(msgId, { status: 'Receiving...' });
                };

                this.eventSource.onmessage = (event) => {
                    if (event.data === '[DONE]') {
                        this.finishStream(msgId);
                        return;
                    }

                    try {
                        const data = JSON.parse(event.data);
                        this.handleEvent(msgId, data);
                    } catch (e) {
                        console.error('Parse error:', e);
                    }
                };

                this.eventSource.onerror = (err) => {
                    console.error('SSE Error:', err);
                    if (this.eventSource.readyState === 2) {
                        this.finishStream(msgId);
                    } else {
                        // Don't show error immediately on simple close, wait for timeout or explicit error
                        // But for now, let's just finish stream to be safe
                        this.finishStream(msgId); 
                    }
                };
            },

            handleEvent(msgId, data) {
                const msgIndex = this.messages.findIndex(m => m.id === msgId);
                if (msgIndex === -1) return;

                const msg = this.messages[msgIndex];

                switch (data.type) {
                    case 'text_chunk':
                    case 'response_chunk':
                        msg.content += data.chunk || '';
                        msg.isThinking = false;
                        break;
                    
                    case 'result_chunk':
                        msg.content += (data.polished_text || data.chunk || '');
                        msg.isThinking = false;
                        break;

                    case 'thinking':
                    case 'processing':
                        msg.isThinking = true;
                        msg.thinkingText = data.message;
                        break;

                    case 'counter':
                        msg.content += `Count: ${data.count}\n`;
                        break;
                    
                    case 'real_time_data':
                        msg.content += `[${data.timestamp}] Value: ${data.value} (${data.status})\n`;
                        break;
                        
                    case 'complete':
                    case 'stream_end':
                        if (!msg.content && data.message) {
                            msg.content = `[System] ${data.message}`;
                        }
                        this.finishStream(msgId);
                        break;
                        
                    case 'error':
                        this.handleError(msgId, data.message);
                        break;
                }
                
                // Only scroll if we are near bottom or it's a new message
                this.scrollToBottom();
            },

            updateMsg(id, updates) {
                const idx = this.messages.findIndex(m => m.id === id);
                if (idx !== -1) {
                    this.messages[idx] = { ...this.messages[idx], ...updates };
                }
            },

            finishStream(msgId) {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
                this.isConnected = false;
                this.statusText = 'Ready';
                this.updateMsg(msgId, { status: 'done', isThinking: false });
            },

            handleError(msgId, errorText) {
                this.finishStream(msgId);
                this.updateMsg(msgId, { 
                    content: this.messages.find(m => m.id === msgId).content + `\n\n[System Error: ${errorText}]`,
                    isError: true 
                });
            },

            stop() {
                if (this.eventSource) {
                    const currentMsg = this.messages.find(m => m.role === 'ai' && m.status !== 'done');
                    if (currentMsg) {
                        this.updateMsg(currentMsg.id, { status: 'done', isThinking: false });
                    }
                    this.eventSource.close();
                    this.isConnected = false;
                }
            }
        }));
    });
</script>
{% endblock %}
