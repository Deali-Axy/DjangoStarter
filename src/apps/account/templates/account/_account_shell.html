{% extends '_base.html' %}
{% load page_tags static %}

{% block messages_area %}{% endblock %}
{% block footer %}{% endblock %}
{% block main_padding %}p-0{% endblock %}

{% block content %}
<div class="drawer lg:drawer-open lg:drawer-end h-[calc(100vh-4rem)] overflow-hidden bg-base-200/30">
    <input id="account-drawer" type="checkbox" class="drawer-toggle" />
    
    <div class="drawer-content flex flex-col h-full overflow-hidden">
        <!-- Mobile Header for Drawer Toggle -->
        <div class="w-full navbar bg-base-100 lg:hidden border-b border-base-200 flex-none z-20">
            <div class="flex-1 px-2 mx-2 font-bold text-lg">用户中心</div>
            <div class="flex-none">
                <label for="account-drawer" aria-label="open sidebar" class="btn btn-square btn-ghost">
                    <i class="fa-solid fa-bars"></i>
                </label>
            </div>
        </div>

        <!-- Main Content Container -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto custom-scrollbar relative" id="account-main">
            {% if messages %}
            <div class="toast toast-top toast-center z-50 sticky top-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} shadow-lg">
                    <span>{{ message }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            {% block account_content %}{% endblock %}
        </main>
    </div> 
    
    <div class="drawer-side z-40 h-full">
        <label for="account-drawer" aria-label="close sidebar" class="drawer-overlay"></label> 
        <aside class="bg-base-100 h-full w-80 p-6 border-l border-base-200 flex flex-col overflow-y-auto custom-scrollbar shadow-sm">
            <!-- User Mini Profile -->
            <div class="flex items-center gap-4 mb-8">
                <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-xl w-12 h-12 ring ring-base-200 ring-offset-2">
                        {% if user.profile.avatar %}
                            <img src="{{ user.profile.avatar.url }}" alt="{{ user.username }}" />
                        {% else %}
                             <img src="https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff&size=128" alt="{{ user.username }}" />
                        {% endif %}
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-base truncate">{{ user.username }}</h3>
                    <p class="text-xs text-base-content/60 truncate">{{ user.email }}</p>
                </div>
                <a href="{% url 'account:settings' %}" class="btn btn-ghost btn-xs btn-square" title="设置">
                    <i class="fa-solid fa-gear"></i>
                </a>
            </div>

            <!-- Navigation Groups -->
            <nav class="flex-1 space-y-6">
                <!-- Main Group -->
                <div>
                    <div class="text-xs font-bold text-base-content/40 uppercase tracking-wider mb-2 px-2">主要功能</div>
                    <ul class="menu menu-md w-full p-0 gap-1">
                        <li>
                            <a href="{% url 'account:index' %}" 
                               hx-get="{% url 'account:index' %}" 
                               hx-target="#account-main" 
                               hx-push-url="true"
                               hx-swap="innerHTML transition:true"
                               class="{% if request.resolver_match.url_name == 'index' %}active{% endif %} rounded-lg">
                                <i class="fa-solid fa-house w-5 opacity-70"></i>
                                概览
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'account:dashboard' %}" 
                               hx-get="{% url 'account:dashboard' %}" 
                               hx-target="#account-main" 
                               hx-push-url="true"
                               hx-swap="innerHTML transition:true"
                               class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %} rounded-lg">
                                <i class="fa-solid fa-chart-line w-5 opacity-70"></i>
                                仪表盘
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Account Group -->
                <div>
                    <div class="text-xs font-bold text-base-content/40 uppercase tracking-wider mb-2 px-2">账户管理</div>
                    <ul class="menu menu-md w-full p-0 gap-1">
                        <li>
                            <a href="{% url 'account:profile' %}" 
                               hx-get="{% url 'account:profile' %}" 
                               hx-target="#account-main" 
                               hx-push-url="true"
                               hx-swap="innerHTML transition:true"
                               class="{% if request.resolver_match.url_name == 'profile' %}active{% endif %} rounded-lg">
                                <i class="fa-solid fa-user-pen w-5 opacity-70"></i>
                                个人资料
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'account:settings' %}" 
                               hx-get="{% url 'account:settings' %}" 
                               hx-target="#account-main" 
                               hx-push-url="true"
                               hx-swap="innerHTML transition:true"
                               class="{% if 'settings' in request.resolver_match.url_name %}active{% endif %} rounded-lg">
                                <i class="fa-solid fa-shield-halved w-5 opacity-70"></i>
                                安全设置
                            </a>
                        </li>
                        <li>
                            <a href="{% url 'account:charge' %}" 
                               hx-get="{% url 'account:charge' %}" 
                               hx-target="#account-main" 
                               hx-push-url="true"
                               hx-swap="innerHTML transition:true"
                               class="{% if request.resolver_match.url_name == 'charge' %}active{% endif %} rounded-lg">
                                <i class="fa-solid fa-wallet w-5 opacity-70"></i>
                                充值中心
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
            
            <!-- Footer Actions -->
            <div class="mt-auto pt-6 border-t border-base-200/50">
                 <ul class="menu w-full p-0">
                    <li>
                        <a href="{% url 'account:logout' %}" class="text-error hover:bg-error/10 rounded-lg group">
                            <i class="fa-solid fa-arrow-right-from-bracket w-5 group-hover:translate-x-1 transition-transform"></i>
                            退出登录
                        </a>
                    </li>
                </ul>
                <div class="text-xs text-center mt-4 text-base-content/30">
                    &copy; {% now "Y" %} DjangoStarter
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Script to handle active state updates for HTMX navigation -->
<script>
    document.body.addEventListener('htmx:afterOnLoad', function(evt) {
        // Update active class on sidebar links
        const currentPath = window.location.pathname;
        const links = document.querySelectorAll('.menu a');
        links.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });
        
        // Close drawer on mobile after navigation
        const drawerCheckbox = document.getElementById('account-drawer');
        if (drawerCheckbox && window.innerWidth < 1024) {
            drawerCheckbox.checked = false;
        }
    });
</script>
{% endblock %}
