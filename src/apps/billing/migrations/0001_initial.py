# Generated by Django 6.0.1 on 2026-01-25 11:56

import django.db.models.deletion
import simple_history.models
from decimal import Decimal
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Plan',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('code', models.SlugField(unique=True, verbose_name='套餐代码')),
                ('name', models.CharField(max_length=100, verbose_name='套餐名称')),
                ('billing_cycle', models.CharField(choices=[('month', '按月'), ('year', '按年')], default='month', max_length=10, verbose_name='计费周期')),
                ('price', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=18, verbose_name='价格')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('is_active', models.BooleanField(default=True, verbose_name='是否上架')),
                ('limits', models.JSONField(blank=True, default=dict, verbose_name='配额/限制')),
                ('features', models.JSONField(blank=True, default=dict, verbose_name='功能开关')),
            ],
            options={
                'verbose_name': '套餐',
                'verbose_name_plural': '套餐',
                'db_table': 'djs_billing_plan',
                'ordering': ['id'],
            },
        ),
        migrations.CreateModel(
            name='HistoricalPlan',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(blank=True, editable=False, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(blank=True, editable=False, verbose_name='更新时间')),
                ('code', models.SlugField(verbose_name='套餐代码')),
                ('name', models.CharField(max_length=100, verbose_name='套餐名称')),
                ('billing_cycle', models.CharField(choices=[('month', '按月'), ('year', '按年')], default='month', max_length=10, verbose_name='计费周期')),
                ('price', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=18, verbose_name='价格')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('is_active', models.BooleanField(default=True, verbose_name='是否上架')),
                ('limits', models.JSONField(blank=True, default=dict, verbose_name='配额/限制')),
                ('features', models.JSONField(blank=True, default=dict, verbose_name='功能开关')),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'historical 套餐',
                'verbose_name_plural': 'historical 套餐',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='LedgerEntry',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('direction', models.CharField(choices=[('credit', '入账'), ('debit', '出账')], max_length=10, verbose_name='方向')),
                ('amount', models.DecimalField(decimal_places=2, max_digits=18, verbose_name='金额')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('reason', models.CharField(choices=[('topup', '充值入账'), ('grant', '赠送/补偿'), ('consume', '使用扣费'), ('refund', '退款/撤销'), ('adjust', '人工调整')], max_length=20, verbose_name='原因')),
                ('reference', models.CharField(blank=True, default='', max_length=200, verbose_name='关联引用')),
                ('idempotency_key', models.CharField(blank=True, default='', max_length=200, verbose_name='幂等键')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='billing_created_ledger_entries', to=settings.AUTH_USER_MODEL, verbose_name='创建人')),
            ],
            options={
                'verbose_name': '账本分录',
                'verbose_name_plural': '账本分录',
                'db_table': 'djs_billing_ledger_entry',
                'ordering': ['-id'],
            },
        ),
        migrations.CreateModel(
            name='HistoricalSubscription',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(blank=True, editable=False, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(blank=True, editable=False, verbose_name='更新时间')),
                ('status', models.CharField(choices=[('trialing', '试用中'), ('active', '生效中'), ('past_due', '欠费'), ('canceled', '已取消'), ('expired', '已失效')], default='active', max_length=20, verbose_name='状态')),
                ('provider', models.CharField(choices=[('admin', '后台开通'), ('stripe', 'Stripe'), ('alipay', '支付宝')], default='admin', max_length=20, verbose_name='来源')),
                ('provider_subscription_id', models.CharField(blank=True, default='', max_length=200, verbose_name='外部订阅ID')),
                ('current_period_start', models.DateTimeField(blank=True, null=True, verbose_name='本期开始时间')),
                ('current_period_end', models.DateTimeField(blank=True, null=True, verbose_name='本期结束时间')),
                ('cancel_at_period_end', models.BooleanField(default=False, verbose_name='到期取消')),
                ('canceled_time', models.DateTimeField(blank=True, null=True, verbose_name='取消时间')),
                ('is_current', models.BooleanField(default=True, verbose_name='是否当前订阅')),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
                ('plan', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='billing.plan', verbose_name='套餐')),
            ],
            options={
                'verbose_name': 'historical 订阅',
                'verbose_name_plural': 'historical 订阅',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='Wallet',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('balance', models.DecimalField(decimal_places=2, default=Decimal('0.00'), max_digits=18, verbose_name='余额')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='billing_wallets', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
            ],
            options={
                'verbose_name': '钱包',
                'verbose_name_plural': '钱包',
                'db_table': 'djs_billing_wallet',
                'ordering': ['-id'],
            },
        ),
        migrations.CreateModel(
            name='TopUp',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('amount', models.DecimalField(decimal_places=2, max_digits=18, verbose_name='充值金额')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('status', models.CharField(choices=[('created', '已创建'), ('pending', '支付中'), ('succeeded', '已成功'), ('failed', '失败'), ('canceled', '已取消'), ('refunded', '已退款')], default='created', max_length=20, verbose_name='状态')),
                ('channel', models.CharField(choices=[('admin', '后台充值'), ('stripe', 'Stripe'), ('alipay', '支付宝')], default='admin', max_length=20, verbose_name='渠道')),
                ('provider_intent_id', models.CharField(blank=True, default='', max_length=200, verbose_name='外部支付意图ID')),
                ('provider_trade_no', models.CharField(blank=True, default='', max_length=200, verbose_name='外部交易号')),
                ('idempotency_key', models.CharField(blank=True, default='', max_length=200, verbose_name='幂等键')),
                ('succeeded_time', models.DateTimeField(blank=True, null=True, verbose_name='成功时间')),
                ('failed_reason', models.CharField(blank=True, default='', max_length=500, verbose_name='失败原因')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='billing_created_topups', to=settings.AUTH_USER_MODEL, verbose_name='创建人')),
                ('credited_entry', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='credited_topup', to='billing.ledgerentry', verbose_name='入账分录')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='billing_topups', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
                ('wallet', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='topups', to='billing.wallet', verbose_name='钱包')),
            ],
            options={
                'verbose_name': '充值单',
                'verbose_name_plural': '充值单',
                'db_table': 'djs_billing_topup',
                'ordering': ['-id'],
            },
        ),
        migrations.AddField(
            model_name='ledgerentry',
            name='wallet',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='ledger_entries', to='billing.wallet', verbose_name='钱包'),
        ),
        migrations.CreateModel(
            name='HistoricalTopUp',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(blank=True, editable=False, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(blank=True, editable=False, verbose_name='更新时间')),
                ('amount', models.DecimalField(decimal_places=2, max_digits=18, verbose_name='充值金额')),
                ('currency', models.CharField(default='CNY', max_length=10, verbose_name='币种')),
                ('status', models.CharField(choices=[('created', '已创建'), ('pending', '支付中'), ('succeeded', '已成功'), ('failed', '失败'), ('canceled', '已取消'), ('refunded', '已退款')], default='created', max_length=20, verbose_name='状态')),
                ('channel', models.CharField(choices=[('admin', '后台充值'), ('stripe', 'Stripe'), ('alipay', '支付宝')], default='admin', max_length=20, verbose_name='渠道')),
                ('provider_intent_id', models.CharField(blank=True, default='', max_length=200, verbose_name='外部支付意图ID')),
                ('provider_trade_no', models.CharField(blank=True, default='', max_length=200, verbose_name='外部交易号')),
                ('idempotency_key', models.CharField(blank=True, default='', max_length=200, verbose_name='幂等键')),
                ('succeeded_time', models.DateTimeField(blank=True, null=True, verbose_name='成功时间')),
                ('failed_reason', models.CharField(blank=True, default='', max_length=500, verbose_name='失败原因')),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('created_by', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='创建人')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
                ('credited_entry', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='billing.ledgerentry', verbose_name='入账分录')),
                ('wallet', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='billing.wallet', verbose_name='钱包')),
            ],
            options={
                'verbose_name': 'historical 充值单',
                'verbose_name_plural': 'historical 充值单',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='Subscription',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('is_deleted', models.BooleanField(default=False, verbose_name='软删除标志')),
                ('created_time', models.DateTimeField(auto_now_add=True, verbose_name='创建时间')),
                ('updated_time', models.DateTimeField(auto_now=True, verbose_name='更新时间')),
                ('status', models.CharField(choices=[('trialing', '试用中'), ('active', '生效中'), ('past_due', '欠费'), ('canceled', '已取消'), ('expired', '已失效')], default='active', max_length=20, verbose_name='状态')),
                ('provider', models.CharField(choices=[('admin', '后台开通'), ('stripe', 'Stripe'), ('alipay', '支付宝')], default='admin', max_length=20, verbose_name='来源')),
                ('provider_subscription_id', models.CharField(blank=True, default='', max_length=200, verbose_name='外部订阅ID')),
                ('current_period_start', models.DateTimeField(blank=True, null=True, verbose_name='本期开始时间')),
                ('current_period_end', models.DateTimeField(blank=True, null=True, verbose_name='本期结束时间')),
                ('cancel_at_period_end', models.BooleanField(default=False, verbose_name='到期取消')),
                ('canceled_time', models.DateTimeField(blank=True, null=True, verbose_name='取消时间')),
                ('is_current', models.BooleanField(default=True, verbose_name='是否当前订阅')),
                ('plan', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='subscriptions', to='billing.plan', verbose_name='套餐')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='billing_subscriptions', to=settings.AUTH_USER_MODEL, verbose_name='用户')),
            ],
            options={
                'verbose_name': '订阅',
                'verbose_name_plural': '订阅',
                'db_table': 'djs_billing_subscription',
                'ordering': ['-id'],
                'constraints': [models.UniqueConstraint(condition=models.Q(('is_current', True)), fields=('user',), name='uniq_current_subscription_per_user')],
            },
        ),
        migrations.AddConstraint(
            model_name='wallet',
            constraint=models.UniqueConstraint(fields=('user', 'currency'), name='uniq_wallet_user_currency'),
        ),
        migrations.AddIndex(
            model_name='topup',
            index=models.Index(fields=['user', 'created_time'], name='djs_billing_user_id_320178_idx'),
        ),
        migrations.AddIndex(
            model_name='topup',
            index=models.Index(fields=['status', 'created_time'], name='djs_billing_status_357f0d_idx'),
        ),
        migrations.AddConstraint(
            model_name='topup',
            constraint=models.UniqueConstraint(condition=models.Q(('provider_trade_no', ''), _negated=True), fields=('channel', 'provider_trade_no'), name='uniq_topup_channel_provider_trade_no'),
        ),
        migrations.AddConstraint(
            model_name='topup',
            constraint=models.UniqueConstraint(condition=models.Q(('provider_intent_id', ''), _negated=True), fields=('channel', 'provider_intent_id'), name='uniq_topup_channel_provider_intent_id'),
        ),
        migrations.AddIndex(
            model_name='ledgerentry',
            index=models.Index(fields=['wallet', 'created_time'], name='djs_billing_wallet__6758dd_idx'),
        ),
        migrations.AddIndex(
            model_name='ledgerentry',
            index=models.Index(fields=['reason', 'created_time'], name='djs_billing_reason_5d1799_idx'),
        ),
        migrations.AddConstraint(
            model_name='ledgerentry',
            constraint=models.UniqueConstraint(condition=models.Q(('idempotency_key', ''), _negated=True), fields=('wallet', 'idempotency_key'), name='uniq_ledger_wallet_idempotency_key'),
        ),
    ]
