{% extends '_base.html' %}

{% load static %}
{% load math_extras %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'lib/aos/aos.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'lib/aos/aos.js' %}"></script>
    <script>
        const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        if (!prefersReducedMotion && window.AOS) {
            AOS.init({
                duration: 600,
                easing: 'ease-out',
                once: true,
            });

            document.body.addEventListener('htmx:afterSwap', () => {
                if (window.AOS && typeof window.AOS.refresh === 'function') {
                    window.AOS.refresh();
                }
            });

            document.addEventListener('aos:in', ({ detail }) => {
                const element = detail;
                // 查找目标 counter 元素：可能是自身，也可能是子元素
                const counter = element.classList.contains('counter') 
                    ? element 
                    : element.querySelector('.counter');

                if (counter && !counter.dataset.counted) {
                    const target = Number(counter.getAttribute('data-count') || '0');
                    let count = 0;
                    const increment = Math.max(1, Math.ceil(target / 80));

                    const updateCounter = () => {
                        count += increment;
                        if (count >= target) {
                            counter.textContent = String(target);
                            counter.dataset.counted = 'true';
                            return;
                        }
                        counter.textContent = String(count);
                        requestAnimationFrame(updateCounter);
                    };

                    updateCounter();
                }
            });
        }
    </script>
{% endblock %}
